<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Threes! 小3传奇</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            touch-action: manipulation;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #2c3e50;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #7f8c8d;
        }
        
        .score-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .score-box {
            background: #34495e;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .game-board {
            width: 100%;
            aspect-ratio: 1/1;
            background: #bbada0;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            height: 100%;
        }
        
        .grid-cell {
            background: rgba(238, 228, 218, 0.35);
            border-radius: 5px;
        }
        
        .tile {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 5px;
            transition: all 0.15s ease;
            z-index: 10;
        }
        
        .tile-1, .tile-2 {
            font-size: 2.5rem;
        }
        
        .tile-1 {
            background: #eee4da;
            color: #776e65;
        }
        
        .tile-2 {
            background: #ede0c8;
            color: #776e65;
        }
        
        .tile-3 {
            background: #f2b179;
            color: #f9f6f2;
            font-size: 2.2rem;
        }
        
        .tile-6 {
            background: #f59563;
            color: #f9f6f2;
            font-size: 2.2rem;
        }
        
        .tile-12 {
            background: #f67c5f;
            color: #f9f6f2;
            font-size: 2rem;
        }
        
        .tile-24 {
            background: #f65e3b;
            color: #f9f6f2;
            font-size: 2rem;
        }
        
        .tile-48 {
            background: #edcf72;
            color: #f9f6f2;
            font-size: 1.8rem;
        }
        
        .tile-96 {
            background: #edcc61;
            color: #f9f6f2;
            font-size: 1.8rem;
        }
        
        .tile-192 {
            background: #edc850;
            color: #f9f6f2;
            font-size: 1.6rem;
        }
        
        .tile-384 {
            background: #edc53f;
            color: #f9f6f2;
            font-size: 1.6rem;
        }
        
        .tile-768 {
            background: #edc22e;
            color: #f9f6f2;
            font-size: 1.4rem;
        }
        
        .next-tile {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            margin: 0 auto 20px;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        button {
            background: #8e44ad;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        button:hover, button:active {
            background: #9b59b6;
            transform: translateY(-2px);
        }
        
        .instructions {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: left;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            z-index: 20;
            display: none;
        }
        
        .game-over-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
        }
        
        .game-over h2 {
            margin-bottom: 15px;
            color: #e74c3c;
        }
        
        @media (max-width: 500px) {
            h1 {
                font-size: 2rem;
            }
            
            .tile-1, .tile-2 {
                font-size: 2rem;
            }
            
            .tile-3, .tile-6 {
                font-size: 1.8rem;
            }
            
            .tile-12, .tile-24 {
                font-size: 1.6rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Threes!</h1>
        <p class="subtitle">滑动合并数字，创造更大的3的倍数！</p>
        
        <div class="score-container">
            <div class="score-box">分数: <span id="score">0</span></div>
            <div class="score-box">最高分: <span id="high-score">0</span></div>
        </div>
        
        <div class="next-tile-container">
            <p>下一个方块:</p>
            <div class="next-tile" id="next-tile">?</div>
        </div>
        
        <div class="game-board" id="game-board">
            <div class="grid-container">
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
                <div class="grid-cell"></div>
            </div>
            
            <div class="game-over" id="game-over">
                <div class="game-over-content">
                    <h2>游戏结束!</h2>
                    <p>你的分数: <span id="final-score">0</span></p>
                    <button id="restart">重新开始</button>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="new-game">新游戏</button>
        </div>
        
        <div class="instructions">
            <h3>游戏规则:</h3>
            <ul>
                <li>滑动屏幕移动所有方块</li>
                <li>数字1和2可以合并成3</li>
                <li>相同的数字可以合并（3+3=6，6+6=12，以此类推）</li>
                <li>棋盘填满且无法移动时游戏结束</li>
                <li>尽量创造更大的数字获得高分！</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 游戏变量
            const gridSize = 4;
            let grid = [];
            let score = 0;
            let highScore = localStorage.getItem('threesHighScore') || 0;
            let nextTileValue = 0;
            let gameOver = false;
            
            // DOM元素
            const gameBoard = document.getElementById('game-board');
            const scoreDisplay = document.getElementById('score');
            const highScoreDisplay = document.getElementById('high-score');
            const nextTileDisplay = document.getElementById('next-tile');
            const gameOverScreen = document.getElementById('game-over');
            const finalScoreDisplay = document.getElementById('final-score');
            const newGameButton = document.getElementById('new-game');
            const restartButton = document.getElementById('restart');
            
            // 初始化游戏
            function initGame() {
                grid = Array(gridSize).fill().map(() => Array(gridSize).fill(0));
                score = 0;
                gameOver = false;
                scoreDisplay.textContent = score;
                highScoreDisplay.textContent = highScore;
                gameOverScreen.style.display = 'none';
                
                // 生成下一个方块
                generateNextTile();
                
                // 添加初始方块
                addRandomTile();
                addRandomTile();
                
                // 渲染游戏板
                renderGrid();
            }
            
            // 生成下一个方块
            function generateNextTile() {
                // 90%概率生成1或2，10%概率生成3
                const rand = Math.random();
                if (rand < 0.9) {
                    nextTileValue = Math.random() < 0.5 ? 1 : 2;
                } else {
                    nextTileValue = 3;
                }
                
                // 更新显示
                nextTileDisplay.textContent = nextTileValue;
                nextTileDisplay.className = 'next-tile';
                nextTileDisplay.classList.add(`tile-${nextTileValue}`);
            }
            
            // 在随机空位置添加方块
            function addRandomTile() {
                const emptyCells = [];
                
                // 找到所有空单元格
                for (let r = 0; r < gridSize; r++) {
                    for (let c = 0; c < gridSize; c++) {
                        if (grid[r][c] === 0) {
                            emptyCells.push({r, c});
                        }
                    }
                }
                
                if (emptyCells.length > 0) {
                    // 随机选择一个空单元格
                    const {r, c} = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    
                    // 放置下一个方块
                    grid[r][c] = nextTileValue;
                    
                    // 生成新的下一个方块
                    generateNextTile();
                    
                    return true;
                }
                
                return false;
            }
            
            // 渲染游戏板
            function renderGrid() {
                // 清除所有现有方块
                document.querySelectorAll('.tile').forEach(tile => tile.remove());
                
                const cellSize = gameBoard.offsetWidth / gridSize - 10;
                
                // 添加所有方块
                for (let r = 0; r < gridSize; r++) {
                    for (let c = 0; c < gridSize; c++) {
                        if (grid[r][c] !== 0) {
                            const tile = document.createElement('div');
                            tile.className = `tile tile-${grid[r][c]}`;
                            tile.textContent = grid[r][c];
                            
                            // 计算位置
                            tile.style.width = `${cellSize}px`;
                            tile.style.height = `${cellSize}px`;
                            tile.style.left = `${c * (cellSize + 10) + 10}px`;
                            tile.style.top = `${r * (cellSize + 10) + 10}px`;
                            
                            gameBoard.appendChild(tile);
                        }
                    }
                }
            }
            
            // 移动方块
            function move(direction) {
                if (gameOver) return false;
                
                let moved = false;
                const oldGrid = JSON.parse(JSON.stringify(grid));
                
                // 根据方向处理移动
                switch(direction) {
                    case 'up':
                        moved = moveUp();
                        break;
                    case 'down':
                        moved = moveDown();
                        break;
                    case 'left':
                        moved = moveLeft();
                        break;
                    case 'right':
                        moved = moveRight();
                        break;
                }
                
                // 如果移动有效，添加新方块并检查游戏状态
                if (moved) {
                    addRandomTile();
                    renderGrid();
                    checkGameOver();
                }
                
                return moved;
            }
            
            // 向上移动
            function moveUp() {
                let moved = false;
                
                for (let c = 0; c < gridSize; c++) {
                    for (let r = 1; r < gridSize; r++) {
                        if (grid[r][c] !== 0) {
                            let newR = r;
                            
                            // 向上移动直到遇到障碍
                            while (newR > 0 && grid[newR-1][c] === 0) {
                                grid[newR-1][c] = grid[newR][c];
                                grid[newR][c] = 0;
                                newR--;
                                moved = true;
                            }
                            
                            // 检查是否可以合并
                            if (newR > 0 && canMerge(grid[newR][c], grid[newR-1][c])) {
                                grid[newR-1][c] = mergeTiles(grid[newR][c], grid[newR-1][c]);
                                grid[newR][c] = 0;
                                score += grid[newR-1][c];
                                scoreDisplay.textContent = score;
                                moved = true;
                            }
                        }
                    }
                }
                
                return moved;
            }
            
            // 向下移动
            function moveDown() {
                let moved = false;
                
                for (let c = 0; c < gridSize; c++) {
                    for (let r = gridSize-2; r >= 0; r--) {
                        if (grid[r][c] !== 0) {
                            let newR = r;
                            
                            // 向下移动直到遇到障碍
                            while (newR < gridSize-1 && grid[newR+1][c] === 0) {
                                grid[newR+1][c] = grid[newR][c];
                                grid[newR][c] = 0;
                                newR++;
                                moved = true;
                            }
                            
                            // 检查是否可以合并
                            if (newR < gridSize-1 && canMerge(grid[newR][c], grid[newR+1][c])) {
                                grid[newR+1][c] = mergeTiles(grid[newR][c], grid[newR+1][c]);
                                grid[newR][c] = 0;
                                score += grid[newR+1][c];
                                scoreDisplay.textContent = score;
                                moved = true;
                            }
                        }
                    }
                }
                
                return moved;
            }
            
            // 向左移动
            function moveLeft() {
                let moved = false;
                
                for (let r = 0; r < gridSize; r++) {
                    for (let c = 1; c < gridSize; c++) {
                        if (grid[r][c] !== 0) {
                            let newC = c;
                            
                            // 向左移动直到遇到障碍
                            while (newC > 0 && grid[r][newC-1] === 0) {
                                grid[r][newC-1] = grid[r][newC];
                                grid[r][newC] = 0;
                                newC--;
                                moved = true;
                            }
                            
                            // 检查是否可以合并
                            if (newC > 0 && canMerge(grid[r][newC], grid[r][newC-1])) {
                                grid[r][newC-1] = mergeTiles(grid[r][newC], grid[r][newC-1]);
                                grid[r][newC] = 0;
                                score += grid[r][newC-1];
                                scoreDisplay.textContent = score;
                                moved = true;
                            }
                        }
                    }
                }
                
                return moved;
            }
            
            // 向右移动
            function moveRight() {
                let moved = false;
                
                for (let r = 0; r < gridSize; r++) {
                    for (let c = gridSize-2; c >= 0; c--) {
                        if (grid[r][c] !== 0) {
                            let newC = c;
                            
                            // 向右移动直到遇到障碍
                            while (newC < gridSize-1 && grid[r][newC+1] === 0) {
                                grid[r][newC+1] = grid[r][newC];
                                grid[r][newC] = 0;
                                newC++;
                                moved = true;
                            }
                            
                            // 检查是否可以合并
                            if (newC < gridSize-1 && canMerge(grid[r][newC], grid[r][newC+1])) {
                                grid[r][newC+1] = mergeTiles(grid[r][newC], grid[r][newC+1]);
                                grid[r][newC] = 0;
                                score += grid[r][newC+1];
                                scoreDisplay.textContent = score;
                                moved = true;
                            }
                        }
                    }
                }
                
                return moved;
            }
            
            // 检查两个方块是否可以合并
            function canMerge(a, b) {
                return (a === 1 && b === 2) || (a === 2 && b === 1) || (a === b && a >= 3);
            }
            
            // 合并两个方块
            function mergeTiles(a, b) {
                if ((a === 1 && b === 2) || (a === 2 && b === 1)) {
                    return 3;
                } else if (a === b && a >= 3) {
                    return a + b;
                }
                return a;
            }
            
            // 检查游戏是否结束
            function checkGameOver() {
                // 检查是否有空单元格
                for (let r = 0; r < gridSize; r++) {
                    for (let c = 0; c < gridSize; c++) {
                        if (grid[r][c] === 0) {
                            return false;
                        }
                    }
                }
                
                // 检查是否还有可合并的相邻方块
                for (let r = 0; r < gridSize; r++) {
                    for (let c = 0; c < gridSize; c++) {
                        const current = grid[r][c];
                        
                        // 检查右侧
                        if (c < gridSize-1 && canMerge(current, grid[r][c+1])) {
                            return false;
                        }
                        
                        // 检查下方
                        if (r < gridSize-1 && canMerge(current, grid[r+1][c])) {
                            return false;
                        }
                    }
                }
                
                // 游戏结束
                gameOver = true;
                
                // 更新最高分
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('threesHighScore', highScore);
                    highScoreDisplay.textContent = highScore;
                }
                
                // 显示游戏结束屏幕
                finalScoreDisplay.textContent = score;
                gameOverScreen.style.display = 'flex';
                
                return true;
            }
            
            // 触摸事件处理
            let startX, startY;
            
            gameBoard.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
            });
            
            gameBoard.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (!startX || !startY) return;
                
                const touch = e.changedTouches[0];
                const diffX = touch.clientX - startX;
                const diffY = touch.clientY - startY;
                
                // 确定滑动方向
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    // 水平滑动
                    if (Math.abs(diffX) > 10) {
                        if (diffX > 0) {
                            move('right');
                        } else {
                            move('left');
                        }
                    }
                } else {
                    // 垂直滑动
                    if (Math.abs(diffY) > 10) {
                        if (diffY > 0) {
                            move('down');
                        } else {
                            move('up');
                        }
                    }
                }
                
                startX = null;
                startY = null;
            });
            
            // 键盘控制（用于测试）
            document.addEventListener('keydown', function(e) {
                switch(e.key) {
                    case 'ArrowUp':
                        move('up');
                        break;
                    case 'ArrowDown':
                        move('down');
                        break;
                    case 'ArrowLeft':
                        move('left');
                        break;
                    case 'ArrowRight':
                        move('right');
                        break;
                }
            });
            
            // 按钮事件
            newGameButton.addEventListener('click', initGame);
            restartButton.addEventListener('click', initGame);
            
            // 初始化游戏
            initGame();
        });
    </script>
</body>
</html>
